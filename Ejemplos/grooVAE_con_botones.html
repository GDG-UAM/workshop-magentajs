<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GrooVAE + MusicVAE – Demo con edición y merge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Magenta.js UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.23.1"></script>
  <style>
    :root { --bg:#0f1115; --panel:#171a21; --accent:#4e9cff; --text:#e6e8ee; --muted:#9aa3b2; }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 800px at 20% 15%, #182034 0%, #10131a 60%, #0b0d12 100%);
      color: var(--text); min-height: 100vh; padding: 24px;
    }
    .app { max-width: 1200px; margin: 0 auto; display: grid; gap: 16px; }
    header { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap: wrap; }
    h1 { font-size: 22px; margin: 0; letter-spacing: .3px; }
    .hint { color: var(--muted); font-size: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card {
      background: linear-gradient(180deg, #1a1f2b 0%, #141821 100%);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px; padding: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.35);
    }
    .card h2 { margin: 0 0 8px; font-size: 16px; font-weight: 600; }
    .controls { display:flex; flex-wrap:wrap; gap: 8px; margin: 10px 0 8px; }
    button {
      appearance: none; border: 1px solid rgba(255,255,255,.1); color: var(--text);
      background: linear-gradient(180deg, #283049 0%, #1b2133 100%);
      padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 13px;
      transition: transform .06s ease, border-color .2s ease, background .2s ease, opacity .2s ease;
    }
    button:hover { border-color: rgba(255,255,255,.22); transform: translateY(-1px); }
    button:disabled { opacity:.5; cursor:not-allowed; transform:none; }
    .primary { background: linear-gradient(180deg, #5aa2ff 0%, #4176ff 100%); border-color: #4e9cff; color: white; }
    .danger  { background: linear-gradient(180deg, #ff5a5a 0%, #e04747 100%); border-color: #ff6a6a; color: white; }
    .meter { color: var(--muted); font-size: 12px; }
    .bpm { display:flex; align-items:center; gap:10px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:8px; }
    svg { width:100%; height: 220px; display:block; background:#0e1118; border-radius: 10px; }
    .cols-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .cols-2 { display:grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    .inline { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    label { font-size: 12px; color: var(--muted); }
    input[type="number"], input[type="range"] {
      background: #0f1421; border: 1px solid rgba(255,255,255,.1); color: var(--text); border-radius: 10px; padding: 6px 10px;
    }
    footer { color: var(--muted); font-size: 12px; text-align: center; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>GrooVAE (Humanize) + MusicVAE (Melody) – Demo</h1>
        <div class="hint">Edita la batería con botones · Humaniza · Genera melodía · Exporta MIDI combinado</div>
      </div>
      <div class="controls">
        <button id="loadGroove" class="primary">Cargar GrooVAE</button>
        <button id="humanize" disabled>Humanizar Batería</button>
        <button id="loadMel" class="primary">Cargar MusicVAE (Melodía)</button>
        <button id="genMel" disabled>Generar Melodía</button>
      </div>
    </header>

    <!-- 1) Panel edición batería -->
    <div class="card">
      <h2>1) Batería – Base Cuantizada (edición rápida)</h2>
      <div class="inline">
        <div class="bpm">
          <label for="bpm">BPM:</label>
          <input id="bpm" type="range" min="60" max="160" step="1" value="110" />
          <span id="bpmVal" class="meter">110</span>
        </div>
        <div class="inline">
          <label for="step">Paso (0–31):</label>
          <input id="step" type="number" min="0" max="31" value="0" />
        </div>
        <div class="inline">
          <label for="vel">Velocidad (40–127):</label>
          <input id="vel" type="range" min="40" max="127" value="100" />
          <span id="velVal" class="meter">100</span>
        </div>
      </div>
      <div class="controls">
        <button id="addKick">+ Kick</button>
        <button id="addSnare">+ Snare</button>
        <button id="addCH">+ Hi-hat Cerrado</button>
        <button id="addOH">+ Hi-hat Abierto</button>
        <button id="clearStep" class="danger">Borrar golpes del paso</button>
        <button id="resetPattern" class="danger">Resetear patrón por defecto</button>
      </div>
      <div class="controls">
        <button id="playIn">▶ Play Base</button>
        <button id="stopIn" class="danger">■ Stop</button>
        <button id="dlIn">⤓ Descargar MIDI (Base)</button>
      </div>
      <svg id="vizIn" aria-label="Visualizer base"></svg>
    </div>

    <!-- 2) Panel salida humanizada + melodía -->
    <div class="row">
      <div class="card">
        <h2>2) Resultado GrooVAE (humanizado)</h2>
        <div class="controls">
          <button id="playOut" disabled>▶ Play Humanizado</button>
          <button id="stopOut" class="danger" disabled>■ Stop</button>
          <button id="dlOut" disabled>⤓ Descargar MIDI (Humanizado)</button>
        </div>
        <svg id="vizOut" aria-label="Visualizer humanizado"></svg>
      </div>

      <div class="card">
        <h2>3) Melodía (MusicVAE)</h2>
        <div class="inline">
          <label for="tempMel">Temperatura:</label>
          <input id="tempMel" type="range" min="0.1" max="1.5" step="0.1" value="1.0">
          <span id="tempMelVal" class="meter">1.0</span>
        </div>
        <div class="controls">
          <button id="playMel" disabled>▶ Play Melodía</button>
          <button id="stopMel" class="danger" disabled>■ Stop</button>
          <button id="dlMel" disabled>⤓ Descargar MIDI (Melodía)</button>
        </div>
        <svg id="vizMel" aria-label="Visualizer melodía"></svg>
      </div>
    </div>

    <!-- 4) Merge y export -->
    <div class="card">
      <h2>4) Exportar MIDI Combinado (Batería + Melodía)</h2>
      <div class="inline" style="margin-bottom:8px;">
        <label><input type="radio" name="drumSource" value="base" checked> Usar batería base</label>
        <label><input type="radio" name="drumSource" value="human"> Usar GrooVAE humanizado</label>
      </div>
      <div class="controls">
        <button id="exportMerged" class="primary">⤓ Exportar MIDI Combinado</button>
      </div>
      <div class="hint">Tip: puedes exportar aunque no hayas humanizado todavía (usa la base).</div>
    </div>

    <footer>
      Checkpoints: groovae_2bar_humanize · mel_2bar_small — Magenta.js
    </footer>
  </div>

  <script>
    // === Checkpoints ===
    const CHECKPOINT_GROOVE = "https://storage.googleapis.com/magentadata/js/checkpoints/music_vae/groovae_2bar_humanize";
    const CHECKPOINT_MELODY = "https://storage.googleapis.com/magentadata/js/checkpoints/music_vae/mel_2bar_small";

    // === Constantes batería ===
    const STEPS_PER_QUARTER = 4;
    const TOTAL_STEPS = 32; // 2 compases de 4/4 a semicorcheas
    const DRUMS = { K:36, S:38, CH:42, OH:46 };

    // === Estado ===
    let modelGroove = null;  // mm.MusicVAE (GrooVAE)
    let modelMel   = null;   // mm.MusicVAE (melody)
    let seqInQ = null;       // Base cuantizada (batería)
    let seqIn  = null;       // Base no cuantizada (para visualizar)
    let seqOut = null;       // Batería humanizada (GrooVAE)
    let seqMel = null;       // Melodía generada (MusicVAE)

    const playerIn  = new mm.Player();
    const playerOut = new mm.Player();
    const playerMel = new mm.Player();

    // === Helpers UI ===
    const $ = id => document.getElementById(id);
    const btnLoadGroove = $('loadGroove');
    const btnHumanize   = $('humanize');
    const btnLoadMel    = $('loadMel');
    const btnGenMel     = $('genMel');

    const playIn  = $('playIn');  const stopIn = $('stopIn');  const dlIn = $('dlIn');
    const playOut = $('playOut'); const stopOut = $('stopOut'); const dlOut = $('dlOut');
    const playMel = $('playMel'); const stopMel = $('stopMel'); const dlMel = $('dlMel');

    const bpm     = $('bpm');   const bpmVal = $('bpmVal');
    const step    = $('step');
    const vel     = $('vel');   const velVal = $('velVal');
    const tempMel = $('tempMel'); const tempMelVal = $('tempMelVal');

    const addKick = $('addKick'); const addSnare = $('addSnare');
    const addCH   = $('addCH');   const addOH    = $('addOH');
    const clearStep = $('clearStep'); const resetPattern = $('resetPattern');

    const vizInSvg  = $('vizIn');
    const vizOutSvg = $('vizOut');
    const vizMelSvg = $('vizMel');
    let vizIn, vizOut, vizMel;

    // === Construcción de patrón base ===
    function makeEmptyQuantized(qpm=110) {
      return {
        quantizationInfo: { stepsPerQuarter: STEPS_PER_QUARTER },
        timeSignatures: [{ time: 0, numerator: 4, denominator: 4 }],
        tempos: [{ time: 0, qpm }],
        notes: [],
        totalQuantizedSteps: TOTAL_STEPS
      };
    }

    function defaultPattern(qpm=110) {
      const qns = makeEmptyQuantized(qpm);
      const add = (pitch, startStep, dur=1, v=100) => {
        qns.notes.push({ pitch, isDrum: true, velocity: v, quantizedStartStep: startStep, quantizedEndStep: startStep + dur });
      };
      // Hi-hat en corcheas
      for (let s=0; s<TOTAL_STEPS; s+=2) add(DRUMS.CH, s, 1, 90);
      // Kick
      [0, 8, 16, 24].forEach(s => add(DRUMS.K, s));
      // Snare
      [4, 12, 20, 28].forEach(s => add(DRUMS.S, s));
      return qns;
    }

    function unquantizeAndDrawBase() {
      const qpm = +bpm.value || 110;
      seqIn = mm.sequences.unquantizeSequence(seqInQ, qpm);
      if (vizInSvg) vizInSvg.replaceChildren();
      vizIn = new mm.PianoRollSVGVisualizer(seqIn, vizInSvg, {
        noteHeight: 8, noteSpacing: 2, pixelsPerTimeStep: 30, activeNoteRGB: '255,255,255'
      });
    }

    function initBase(reset=true) {
      const qpm = +bpm.value || 110;
      seqInQ = reset ? defaultPattern(qpm) : { ...seqInQ, tempos: [{ time: 0, qpm }] };
      unquantizeAndDrawBase();
    }

    // === Edición por botones (añadir/borrar) ===
    function pushDrumHit(pitch, stepIdx, velocity) {
      // Si ya hay un golpe exactamente en ese pitch y paso, evita duplicados exactos
      const exists = seqInQ.notes.some(n =>
        n.isDrum && n.pitch===pitch && n.quantizedStartStep===stepIdx && n.quantizedEndStep===stepIdx+1
      );
      if (!exists) {
        seqInQ.notes.push({
          pitch, isDrum:true, velocity: velocity|0,
          quantizedStartStep: stepIdx|0, quantizedEndStep: (stepIdx|0)+1
        });
        unquantizeAndDrawBase();
      }
    }

    function clearDrumHitsAtStep(stepIdx) {
      seqInQ.notes = seqInQ.notes.filter(n => !(n.isDrum && n.quantizedStartStep===stepIdx));
      unquantizeAndDrawBase();
    }

    // === Descarga MIDI ===
    function downloadMidi(ns, filename='out.mid') {
      const bytes = mm.sequenceProtoToMidi(ns);
      const blob = new Blob([bytes], { type: 'audio/midi' });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href:url, download: filename });
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    // === Visualizadores auxiliares ===
    function drawOut() {
      if (!seqOut) return;
      if (vizOutSvg) vizOutSvg.replaceChildren();
      vizOut = new mm.PianoRollSVGVisualizer(seqOut, vizOutSvg, {
        noteHeight: 8, noteSpacing: 2, pixelsPerTimeStep: 30, activeNoteRGB: '255,255,255'
      });
    }
    function drawMel() {
      if (!seqMel) return;
      if (vizMelSvg) vizMelSvg.replaceChildren();
      vizMel = new mm.PianoRollSVGVisualizer(seqMel, vizMelSvg, {
        noteHeight: 8, noteSpacing: 2, pixelsPerTimeStep: 30, activeNoteRGB: '255,255,255'
      });
    }

    // === Inicializar base por defecto ===
    initBase(true);

    // === Wiring UI ===
    bpm.addEventListener('input', () => { bpmVal.textContent = bpm.value; initBase(false); });
    vel.addEventListener('input', () => velVal.textContent = vel.value);
    tempMel.addEventListener('input', () => tempMelVal.textContent = tempMel.value);

    addKick.addEventListener('click', () => pushDrumHit(DRUMS.K, +step.value, +vel.value));
    addSnare.addEventListener('click', () => pushDrumHit(DRUMS.S, +step.value, +vel.value));
    addCH.addEventListener('click',   () => pushDrumHit(DRUMS.CH, +step.value, +vel.value));
    addOH.addEventListener('click',   () => pushDrumHit(DRUMS.OH, +step.value, +vel.value));
    clearStep.addEventListener('click', () => clearDrumHitsAtStep(+step.value));
    resetPattern.addEventListener('click', () => initBase(true));

    // Repro/stop base
    playIn.addEventListener('click', async () => {
      try { playerOut.stop(); playerMel.stop(); await playerIn.start(seqInQ, +bpm.value); } catch {}
    });
    stopIn.addEventListener('click', () => playerIn.stop());
    dlIn.addEventListener('click', () => downloadMidi(seqInQ, 'drums_base.mid'));

    // Cargar GrooVAE
    btnLoadGroove.addEventListener('click', async () => {
      btnLoadGroove.disabled = true;
      try {
        modelGroove = new mm.MusicVAE(CHECKPOINT_GROOVE);
        await modelGroove.initialize();
        btnHumanize.disabled = false;
        btnLoadGroove.textContent = 'GrooVAE listo ✓';
      } catch (e) {
        console.error(e);
        btnLoadGroove.disabled = false;
        btnLoadGroove.textContent = 'Reintentar GrooVAE';
        alert('No se pudo cargar GrooVAE.');
      }
    });

    // Humanizar
    btnHumanize.addEventListener('click', async () => {
      if (!modelGroove) return;
      btnHumanize.disabled = true;
      try {
        const z = await modelGroove.encode([seqInQ]);
        const outs = await modelGroove.decode(z, 0.8);
        seqOut = outs[0];
        drawOut();
        playOut.disabled = stopOut.disabled = dlOut.disabled = false;
        btnHumanize.textContent = 'Humanizado ✓';
      } catch(e) {
        console.error(e);
        btnHumanize.disabled = false;
        btnHumanize.textContent = 'Humanizar Batería';
        alert('Falló la humanización.');
      }
    });

    // Repro/stop humanizado
    playOut.addEventListener('click', async () => {
      try { playerIn.stop(); playerMel.stop(); if (seqOut) await playerOut.start(seqOut); } catch {}
    });
    stopOut.addEventListener('click', () => playerOut.stop());
    dlOut.addEventListener('click', () => seqOut && downloadMidi(seqOut, 'drums_humanized.mid'));

    // Cargar MusicVAE (melodía)
    btnLoadMel.addEventListener('click', async () => {
      btnLoadMel.disabled = true;
      try {
        modelMel = new mm.MusicVAE(CHECKPOINT_MELODY);
        await modelMel.initialize();
        btnGenMel.disabled = false;
        btnLoadMel.textContent = 'MusicVAE (Melodía) listo ✓';
      } catch(e) {
        console.error(e);
        btnLoadMel.disabled = false;
        btnLoadMel.textContent = 'Reintentar MusicVAE';
        alert('No se pudo cargar MusicVAE (melodía).');
      }
    });

    // Generar melodía
    btnGenMel.addEventListener('click', async () => {
      if (!modelMel) return;
      btnGenMel.disabled = true;
      try {
        const [mel] = await modelMel.sample(1, +tempMel.value);
        // Asegura flags de instrumento melódico
        mel.notes.forEach(n => { n.isDrum = false; if (n.program == null) n.program = 0; });
        seqMel = mel;
        drawMel();
        playMel.disabled = stopMel.disabled = dlMel.disabled = false;
        btnGenMel.textContent = 'Melodía lista ✓';
      } catch(e) {
        console.error(e);
        btnGenMel.disabled = false;
        btnGenMel.textContent = 'Generar Melodía';
        alert('No se pudo generar la melodía.');
      }
    });

    // Repro/stop melodía
    playMel.addEventListener('click', async () => {
      try { playerIn.stop(); playerOut.stop(); if (seqMel) await playerMel.start(seqMel); } catch {}
    });
    stopMel.addEventListener('click', () => playerMel.stop());
    dlMel.addEventListener('click', () => seqMel && downloadMidi(seqMel, 'melody.mid'));

    // === Merge & export ===
    function mergeSequences(nsA, nsB) {
      // Crea un NoteSequence no cuantizado con tiempos en segundos
      const out = { notes: [], tempos: [], timeSignatures: [], totalTime: 0 };
      // Tempo: usa BPM actual como referencia si alguna carece de tempos
      const qpm = +bpm.value || 110;
      out.tempos = [{ time: 0, qpm }];

      const addAll = (src) => {
        if (!src) return;
        // Si está cuantizado, des-cuantiza a tiempo real
        const isQuantized = !!src.quantizationInfo;
        let unq = src;
        if (isQuantized) unq = mm.sequences.unquantizeSequence(src, qpm);
        (unq.notes || []).forEach(n => out.notes.push({ ...n }));
        out.totalTime = Math.max(out.totalTime || 0, unq.totalTime || 0);
      };

      addAll(nsA);
      addAll(nsB);
      return out;
    }

    const exportMergedBtn = $('exportMerged');
    exportMergedBtn.addEventListener('click', () => {
      // Elegir fuente de batería: base o humanizada
      const drumSource = [...document.querySelectorAll('input[name="drumSource"]')]
        .find(r => r.checked)?.value || 'base';

      const drumsNS = (drumSource === 'human' && seqOut) ? seqOut : seqInQ;
      if (!drumsNS) { alert('No hay batería disponible.'); return; }
      if (!seqMel)  { alert('Genera una melodía primero.'); return; }

      const merged = mergeSequences(drumsNS, seqMel);
      downloadMidi(merged, 'merged_drums_melody.mid');
    });
  </script>
</body>
</html>
