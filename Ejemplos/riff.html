<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Band Studio (Riff de Rock)</title>
    <style>
        body { font-family: 'Google Sans', sans-serif, system-ui; text-align: center; background: #f0f2f5; color: #333; padding: 1em; }
        .container { max-width: 800px; margin: auto; background: white; padding: 2em; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { color: #1a73e8; }
        #generateButton {
            background-color: #34A853; color: white; border: none; padding: 15px 30px;
            font-size: 18px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; margin-top: 20px;
        }
        #generateButton:disabled { background-color: #9e9e9e; cursor: not-allowed; }
        #visualizer { margin-top: 25px; border: 1px solid #ccc; width: 100%; box-sizing: border-box;}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.23.1/dist/magentamusic.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üé∏ AI Band Studio (Riff de Rock) ü•Å</h1>
        <p>Pulsa "Componer" para que la IA cree una base para este nuevo riff de rock cl√°sico.</p>
        
        <button id="generateButton" disabled>Cargando Modelos...</button>
        <canvas id="visualizer"></canvas>
    </div>

    <script>
        const trioVAE = new mm.MusicVAE('https://storage.googleapis.com/magentadata/js/checkpoints/music_vae/trio_16bar');
        const soundFontPlayer = new mm.SoundFontPlayer('https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus');

        // --- EL NUEVO RIFF DE ROCK CL√ÅSICO ---
        // Este riff de 4 compases tiene una progresi√≥n arm√≥nica (Am - G - C - F)
        // y usa notas dobles para un sonido m√°s lleno.
        const classicRockRiff = {
            notes: [
                // Bar 1: Am
                {pitch: 57, quantizedStartStep: 0, quantizedEndStep: 4},   // A3
                {pitch: 60, quantizedStartStep: 4, quantizedEndStep: 8},   // C4
                {pitch: 64, quantizedStartStep: 8, quantizedEndStep: 12},  // E4
                {pitch: 60, quantizedStartStep: 12, quantizedEndStep: 16}, // C4
                
                // Bar 2: G
                {pitch: 55, quantizedStartStep: 16, quantizedEndStep: 20}, // G3
                {pitch: 59, quantizedStartStep: 20, quantizedEndStep: 24}, // B3
                {pitch: 62, quantizedStartStep: 24, quantizedEndStep: 28}, // D4
                {pitch: 59, quantizedStartStep: 28, quantizedEndStep: 32}, // B3

                // Bar 3: C
                {pitch: 60, quantizedStartStep: 32, quantizedEndStep: 36}, // C4
                {pitch: 64, quantizedStartStep: 36, quantizedEndStep: 40}, // E4
                {pitch: 67, quantizedStartStep: 40, quantizedEndStep: 44}, // G4
                {pitch: 64, quantizedStartStep: 44, quantizedEndStep: 48}, // E4

                // Bar 4: F (con notas dobles)
                {pitch: 53, quantizedStartStep: 48, quantizedEndStep: 56}, // F3
                {pitch: 60, quantizedStartStep: 48, quantizedEndStep: 56}, // C4 (suena a la vez que F3)
                {pitch: 57, quantizedStartStep: 56, quantizedEndStep: 64}, // A3
                {pitch: 65, quantizedStartStep: 56, quantizedEndStep: 64}, // F4 (suena a la vez que A3)
            ],
            quantizationInfo: {stepsPerQuarter: 4},
            totalQuantizedSteps: 64,
        };

        trioVAE.initialize().then(() => {
            document.getElementById('generateButton').disabled = false;
            document.getElementById('generateButton').innerText = '¬°Componer!';
        });

        const generateButton = document.getElementById('generateButton');
        generateButton.onclick = async () => {
            if (soundFontPlayer.isPlaying()) {
                soundFontPlayer.stop();
                generateButton.innerText = '¬°Componer!';
                return;
            }

            generateButton.disabled = true;
            generateButton.innerText = 'Componiendo... üß†';

            const trioPart = (await trioVAE.sample(1))[0];
            
            const allGuitarNotes = [];
            const riffDuration = classicRockRiff.totalQuantizedSteps;
            // El tr√≠o dura 256 pasos (16 compases), y el riff 64 (4 compases).
            // Lo repetimos 4 veces.
            const repetitions = trioPart.totalQuantizedSteps / riffDuration;

            for (let i = 0; i < repetitions; i++) {
                const timeOffset = i * riffDuration;
                classicRockRiff.notes.forEach(originalNote => {
                    const newNote = {
                        ...originalNote,
                        quantizedStartStep: originalNote.quantizedStartStep + timeOffset,
                        quantizedEndStep: originalNote.quantizedEndStep + timeOffset,
                        program: 29 // Overdriven Guitar
                    };
                    allGuitarNotes.push(newNote);
                });
            }

            const fullGuitarPart = {
                notes: allGuitarNotes,
                totalQuantizedSteps: trioPart.totalQuantizedSteps,
                quantizationInfo: classicRockRiff.quantizationInfo
            };

            const allNotes = [...trioPart.notes, ...fullGuitarPart.notes];
            const finalSequence = {
                notes: allNotes,
                totalQuantizedSteps: trioPart.totalQuantizedSteps,
                quantizationInfo: { stepsPerQuarter: 4 }
            };

            const visualizer = new mm.PianoRollCanvasVisualizer(finalSequence, document.getElementById('visualizer'));

            generateButton.innerText = 'Cargando Instrumentos...';
            await soundFontPlayer.loadSamples(finalSequence);
            
            generateButton.disabled = false;
            generateButton.innerText = '‚ñ† Detener';
            soundFontPlayer.start(finalSequence).then(() => {
                generateButton.innerText = '¬°Componer!';
            });
        };
    </script>
</body>
</html>