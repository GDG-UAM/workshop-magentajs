<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GrooVAE (Humanize) – Demo rápida</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Magenta.js UMD (expone `mm` en window) -->
  <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.23.1"></script>
  <style>
    :root { --bg:#0f1115; --panel:#171a21; --accent:#4e9cff; --text:#e6e8ee; --muted:#9aa3b2; }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 800px at 20% 15%, #182034 0%, #10131a 60%, #0b0d12 100%);
      color: var(--text); min-height: 100vh; display: grid; place-items: center; padding: 24px;
    }
    .app { width: min(1100px, 100%); display: grid; gap: 16px; }
    header { display:flex; gap:10px; align-items:center; justify-content:space-between; }
    h1 { font-size: 22px; margin: 0; letter-spacing: .3px; }
    .hint { color: var(--muted); font-size: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card {
      background: linear-gradient(180deg, #1a1f2b 0%, #141821 100%);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px; padding: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.35);
    }
    .card h2 { margin: 0 0 8px; font-size: 16px; font-weight: 600; }
    .controls { display:flex; flex-wrap:wrap; gap: 8px; margin: 10px 0 8px; }
    button, .btn {
      appearance: none; border: 1px solid rgba(255,255,255,.1); color: var(--text);
      background: linear-gradient(180deg, #283049 0%, #1b2133 100%);
      padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 13px;
      transition: transform .06s ease, border-color .2s ease, background .2s ease, opacity .2s ease;
    }
    button:hover { border-color: rgba(255,255,255,.22); transform: translateY(-1px); }
    button:disabled { opacity:.5; cursor:not-allowed; transform:none; }
    .primary { background: linear-gradient(180deg, #5aa2ff 0%, #4176ff 100%); border-color: #4e9cff; color: white; }
    .danger  { background: linear-gradient(180deg, #ff5a5a 0%, #e04747 100%); border-color: #ff6a6a; color: white; }
    .meter { color: var(--muted); font-size: 12px; }
    .bpm { display:flex; align-items:center; gap:10px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:8px; }
    .two { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    svg { width:100%; height: 220px; display:block; background:#0e1118; border-radius: 10px; }
    footer { color: var(--muted); font-size: 12px; text-align: center; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>GrooVAE (2-bar Humanize) – Demo</h1>
        <div class="hint">1) Carga el modelo · 2) Humaniza la base · 3) Reproduce y descarga</div>
      </div>
      <div class="controls">
        <button id="load" class="primary">Cargar GrooVAE</button>
        <button id="humanize" disabled>Humanizar</button>
      </div>
    </header>

    <div class="row">
      <div class="card">
        <h2>Base Cuantizada (rock 2 compases)</h2>
        <div class="controls">
          <button id="playIn">▶ Play</button>
          <button id="stopIn" class="danger">■ Stop</button>
          <button id="dlIn">⤓ Descargar MIDI</button>
        </div>
        <div class="bpm">
          <label for="bpm">BPM:</label>
          <input id="bpm" type="range" min="60" max="160" step="1" value="110" />
          <span id="bpmVal" class="meter">110</span>
        </div>
        <div class="grid">
          <svg id="vizIn" aria-label="Visualizer base"></svg>
        </div>
      </div>

      <div class="card">
        <h2>Resultado GrooVAE (humanizado)</h2>
        <div class="controls">
          <button id="playOut" disabled>▶ Play</button>
          <button id="stopOut" class="danger" disabled>■ Stop</button>
          <button id="dlOut" disabled>⤓ Descargar MIDI</button>
        </div>
        <div class="grid">
          <svg id="vizOut" aria-label="Visualizer humanizado"></svg>
        </div>
      </div>
    </div>

    <footer>
      Checkpoint: groovae_2bar_humanize · API: MusicVAE / sequences / midi_io (Magenta.js)
    </footer>
  </div>

  <script>
    // === Config y estado ===
    const CHECKPOINT = "https://storage.googleapis.com/magentadata/js/checkpoints/music_vae/groovae_2bar_humanize"; // 
    const STEPS_PER_QUARTER = 4;
    const TOTAL_STEPS = 32; // 2 compases a 4/4 con 16ªs
    const DRUMS = { K:36, S:38, CH:42, OH:46 };

    let model;                 // mm.MusicVAE
    let seqInQ;                // NoteSequence cuantizado (base)
    let seqIn;                 // versión no cuantizada para visualizar
    let seqOut;                // salida humanizada (no cuantizada)
    const playerIn  = new mm.Player(); // Reproductor base
    const playerOut = new mm.Player(); // Reproductor salida

    // Visualizadores
    const vizInSvg  = document.getElementById('vizIn');
    const vizOutSvg = document.getElementById('vizOut');
    let vizIn, vizOut;

    // === Construye una base de batería de 2 compases (rock) cuantizada ===
    function buildQuantizedRock(qpm=110) {
      const qns = {
        quantizationInfo: { stepsPerQuarter: STEPS_PER_QUARTER },
        timeSignatures: [{ time: 0, numerator: 4, denominator: 4 }],
        tempos: [{ time: 0, qpm }],
        notes: [],
        totalQuantizedSteps: TOTAL_STEPS
      };
      const add = (pitch, startStep, durSteps=1, vel=100)=> {
        qns.notes.push({
          pitch, isDrum: true, velocity: vel,
          quantizedStartStep: startStep,
          quantizedEndStep: startStep + durSteps
        });
      };

      // Hi-hat semicorcheas (o corcheas cambiando +2 a +1)
      for (let s=0; s<TOTAL_STEPS; s+=2) add(DRUMS.CH, s, 1, 90);
      // Kick en 1 y 3 (pasos 0 y 8) + rellenos ligeros
      add(DRUMS.K, 0); add(DRUMS.K, 8);
      add(DRUMS.K, 14); add(DRUMS.K, 22);
      // Snare en 2 y 4 (pasos 4 y 12)
      add(DRUMS.S, 4); add(DRUMS.S, 12); add(DRUMS.S, 20); add(DRUMS.S, 28);
      /// AÑADIDO POR MI
      add(38, 4); 
      add(38, 12);

      // Hi-hat en corcheas (cada 2 pasos)
      for (let s=0; s<32; s+=2) add(42, s, 1, 90);
      // Kick en 1 (0) y 3 (8); Snare en 2 (4) y 4 (12) y repite en compás 2 (+16)
      [0, 8, 16, 24].forEach(s => add(36, s));    // kicks
      [4, 12, 20, 28].forEach(s => add(38, s));   // snares

      return qns;
    }

    // === Render ayuda ===
    function drawIn() {
      if (vizInSvg) vizInSvg.replaceChildren();
      vizIn = new mm.PianoRollSVGVisualizer(seqIn, vizInSvg, {
        noteHeight: 8, noteSpacing: 2, pixelsPerTimeStep: 30, activeNoteRGB: '255,255,255'
      }); // :contentReference[oaicite:1]{index=1}
    }
    function drawOut() {
      if (!seqOut) return;
      if (vizOutSvg) vizOutSvg.replaceChildren();
      vizOut = new mm.PianoRollSVGVisualizer(seqOut, vizOutSvg, {
        noteHeight: 8, noteSpacing: 2, pixelsPerTimeStep: 30, activeNoteRGB: '255,255,255'
      }); // :contentReference[oaicite:2]{index=2}
    }

    // === Descarga MIDI (convierte NoteSequence → .mid) ===
    function downloadMidi(ns, filename='groovae.mid') {
      const bytes = mm.sequenceProtoToMidi(ns); // :contentReference[oaicite:3]{index=3}
      const blob = new Blob([bytes], { type: 'audio/midi' });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href:url, download: filename });
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    // === UI wiring ===
    const $ = id => document.getElementById(id);
    const btnLoad     = $('load');
    const btnHumanize = $('humanize');
    const bpmRange    = $('bpm');
    const bpmVal      = $('bpmVal');

    const playIn  = $('playIn');
    const stopIn  = $('stopIn');
    const dlIn    = $('dlIn');
    const playOut = $('playOut');
    const stopOut = $('stopOut');
    const dlOut   = $('dlOut');

    // Inicializa base
    function initBase() {
      const qpm = +bpmRange.value || 110;
      seqInQ = buildQuantizedRock(qpm);
      seqIn  = mm.sequences.unquantizeSequence(seqInQ, qpm); // para visualizar en tiempo real (s) :contentReference[oaicite:4]{index=4}
      drawIn();
    }
    initBase();

    // BPM UI
    bpmRange.addEventListener('input', () => {
      bpmVal.textContent = bpmRange.value;
      initBase();
    });

    // Cargar modelo
    btnLoad.addEventListener('click', async () => {
      btnLoad.disabled = true;
      try {
        model = new mm.MusicVAE(CHECKPOINT); // :contentReference[oaicite:5]{index=5}
        await model.initialize();            // :contentReference[oaicite:6]{index=6}
        btnHumanize.disabled = false;
        btnLoad.textContent = 'GrooVAE listo ✓';
      } catch (e) {
        console.error(e);
        btnLoad.disabled = false;
        btnLoad.textContent = 'Reintentar cargar GrooVAE';
        alert('No se pudo cargar el modelo. Revisa conexión o vuelve a intentar.');
      }
    });

    // Humanizar
    btnHumanize.addEventListener('click', async () => {
      if (!model) return;
      btnHumanize.disabled = true;
      try {
        // Encode → Decode con el checkpoint "humanize" (devuelve secuencia no cuantizada)
        const z = await model.encode([seqInQ]);                // :contentReference[oaicite:7]{index=7}
        const outs = await model.decode(z, 0.8 /*temp*/);      // :contentReference[oaicite:8]{index=8}
        seqOut = outs[0];
        drawOut();
        playOut.disabled = stopOut.disabled = dlOut.disabled = false;
        btnHumanize.textContent = 'Humanizado ✓';
      } catch (e) {
        console.error(e);
        btnHumanize.disabled = false;
        btnHumanize.textContent = 'Humanizar';
        alert('Falló la humanización (revisa la consola).');
      }
    });

    // Repro base (usa QPM para secuencia cuantizada)
    playIn.addEventListener('click', async () => {
      try {
        playerOut.stop();
        await playerIn.start(seqInQ, +bpmRange.value); // start() devuelve Promise al terminar :contentReference[oaicite:9]{index=9}
      } catch (e) { console.warn(e); }
    });
    stopIn.addEventListener('click', () => playerIn.stop());

    // Repro salida (no cuantizada, ignora QPM)
    playOut.addEventListener('click', async () => {
      if (!seqOut) return;
      try {
        playerIn.stop();
        await playerOut.start(seqOut); // para no cuantizada, reproduce a tiempo real del resultado :contentReference[oaicite:10]{index=10}
      } catch (e) { console.warn(e); }
    });
    stopOut.addEventListener('click', () => playerOut.stop());

    // Descargas
    dlIn.addEventListener('click', () => downloadMidi(seqInQ, 'groovae_base.mid'));
    dlOut.addEventListener('click', () => seqOut && downloadMidi(seqOut, 'groovae_humanizado.mid'));
  </script>
</body>
</html>
