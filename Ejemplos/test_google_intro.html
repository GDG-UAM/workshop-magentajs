<!-- Preparaci√≥n de donde vivir√° la app -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Banda de IA Sincronizada</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f2f5; }
        h1 { color: #1a73e8; }
        #playButton {
            background-color: #34a853; color: white; border: none; padding: 15px 30px;
            font-size: 18px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s;
        }
        #playButton:disabled { background-color: #9e9e9e; }
        #visualizer { margin-top: 25px; border: 1px solid #ccc; }
    </style>
    <!-- Antes de nada, descarga la caja de herramientas de magenta -->
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.23.1/dist/magentamusic.min.js"></script>
</head>
<body>

    <h1>üéµ Mi Banda de IA (Sincronizada) ü•Å</h1>
    <p>Presiona para generar una melod√≠a con su propio ritmo de bater√≠a... ¬°a la vez!</p>

    <button id="playButton" disabled>Cargando Modelos...</button>
    <canvas id="visualizer"></canvas>

    <script>
        // Preparaci√≥n de los m√∫sicos
        const melodiaRNN = new mm.MusicRNN('https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/basic_rnn');
        const bateriaVAE = new mm.MusicVAE('https://storage.googleapis.com/magentadata/js/checkpoints/music_vae/drums_2bar_lokl_small');

        // El reproductor de m√∫sica
        let player = new mm.Player();
        // Prepara el visualizador
        let visualizer;
        
        // Inicializa los dos modelos a la vez y espera a que est√©n listos
        Promise.all([
            melodiaRNN.initialize(),
            bateriaVAE.initialize()
        ]).then(() => {
            // luego se habilita el bot√≥n de reproducci√≥n y se le pone texto
            document.getElementById('playButton').disabled = false;
            document.getElementById('playButton').innerText = '¬°Crear y Tocar!';
        });
        
        // Se pone en una variable el listener del boton de play (Conecta usuario y c√≥digo)
        const playButton = document.getElementById('playButton');
        playButton.onclick = async () => { // Indica que no quiere que el ordenador se congele
            if (player.isPlaying()) {
                player.stop(); //para la musica
                playButton.innerText = '¬°Crear y Tocar!'; // Restablece el texto del bot√≥n
                return;
            }

            playButton.disabled = true;
            playButton.innerText = 'Creando...';

            // Idea que le damos a nuestro pianista
            const ideaInicial = {
                notes: [{ pitch: 60, quantizedStartStep: 0, quantizedEndStep: 4 }],
                quantizationInfo: { stepsPerQuarter: 4 },
                totalQuantizedSteps: 4
            };
            // await indica al c√≥digo que viene despu√©s no se ejecutar√° hasta que se complete la promesa
            // Compone 60 notas con una creatividad de 1.1
            const continuacionMelodia = await melodiaRNN.continueSequence(ideaInicial, 60, 1.1);
            // Improvisa un nuevo ritmo de bater√≠a
            const ritmoBateria = (await bateriaVAE.sample(1))[0];

            // ----------------- EL CAMBIO CLAVE EST√Å AQU√ç -----------------

            // 1. Unimos las listas de notas de ambas secuencias en un solo array.
            const notasCombinadas = [...continuacionMelodia.notes, ...ritmoBateria.notes];

            // 2. Creamos la secuencia final a mano. (Fusiona)
            const cancionFinal = {
                notes: notasCombinadas,
                // 3. La duraci√≥n total es la M√ÅXIMA de las dos partes, no la suma.
                totalQuantizedSteps: Math.max(continuacionMelodia.totalQuantizedSteps, ritmoBateria.totalQuantizedSteps),
                quantizationInfo: continuacionMelodia.quantizationInfo // Usamos la de la melod√≠a
            };

            // ----------------- FIN DEL CAMBIO -----------------
            // Dibuja la cancion final
            visualizer = new mm.Visualizer(cancionFinal, document.getElementById('visualizer'));

            // Indica:
            // Reproduce la musica -> Cuando haya terminado (then) -> Habilita el bot√≥n y vuelve a tocar
            player.start(cancionFinal).then(() => {
                playButton.disabled = false;
                playButton.innerText = '¬°Crear y Tocar!';
            });

            playButton.disabled = false;
            playButton.innerText = '‚ñ† Detener';
        };
    </script>
</body>
</html>